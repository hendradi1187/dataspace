# Development Dockerfile for Broker Service
FROM node:20-alpine

# Install dumb-init for proper signal handling and curl for health checks
RUN apk add --no-cache dumb-init curl

# Create app user for security
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# Install pnpm globally
RUN npm install -g pnpm@latest

# Set working directory
WORKDIR /app

# Copy root package.json and pnpm files for workspace
COPY --chown=nodejs:nodejs tsconfig.json package.json pnpm-workspace.yaml pnpm-lock.yaml ./

# Copy all package.json files FIRST (pnpm needs to see the structure)
COPY --chown=nodejs:nodejs services/cts/*/package.json ./services/cts/
COPY --chown=nodejs:nodejs libs/*/package.json ./libs/
COPY --chown=nodejs:nodejs apps/frontend/package.json ./apps/frontend/

# Copy ALL source code BEFORE pnpm install
# This is critical - pnpm needs to see the actual code for workspace linking
COPY --chown=nodejs:nodejs libs ./libs
COPY --chown=nodejs:nodejs services/cts/broker ./services/cts/broker
COPY --chown=nodejs:nodejs apps ./apps

# Install all dependencies from lock file (workspace mode)
# This will properly create symlinks for @dataspace/* packages
RUN pnpm install --no-frozen-lockfile

# Switch to non-root user
USER nodejs

# Set entrypoint for proper signal handling
ENTRYPOINT ["dumb-init", "--"]

# Expose port
EXPOSE 3001

# Start command
CMD ["pnpm", "-C", "services/cts/broker", "dev"]
