# Development Dockerfile for Frontend Service
FROM node:20-alpine

# Install curl for health checks
RUN apk add --no-cache curl

# Create app user for security
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# Install pnpm globally
RUN npm install -g pnpm@latest

# Set working directory
WORKDIR /app

# Copy root package.json and pnpm files for workspace
COPY --chown=nodejs:nodejs tsconfig.json package.json pnpm-workspace.yaml pnpm-lock.yaml ./

# Copy all service package.json files
COPY --chown=nodejs:nodejs services/cts/*/package.json ./services/cts/
COPY --chown=nodejs:nodejs libs/*/package.json ./libs/
COPY --chown=nodejs:nodejs apps/frontend/package.json ./apps/frontend/

# Copy source code BEFORE install for proper workspace symlinks
COPY --chown=nodejs:nodejs libs ./libs
COPY --chown=nodejs:nodejs apps/frontend ./apps/frontend

# Install all dependencies from lock file (workspace mode)
RUN pnpm install --no-frozen-lockfile

# Install frontend-specific node_modules
RUN pnpm -C apps/frontend install --no-frozen-lockfile

# Fix permissions for frontend directory
RUN chown -R nodejs:nodejs /app/apps/frontend

# Switch to non-root user
USER nodejs

# Expose port
EXPOSE 5174

# Start command
CMD ["sh", "-c", "cd apps/frontend && pnpm run dev -- --host 0.0.0.0"]
